<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Barangay + Purok Shape Getter</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="osmtogeojson.js"></script> <!-- local copy -->

    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f4f6f9;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        /* Control box */
        #controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        #controls:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
        }

        /* Input styling */
        #search {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            outline: none;
            width: 280px;
            transition: border-color 0.2s;
        }

        #search:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        /* Button styling */
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        button:first-of-type {
            background: #3b82f6;
            color: white;
        }

        button:first-of-type:hover {
            background: #2563eb;
        }

        #download {
            background: #10b981;
            color: white;
            display: none;
        }

        #download:hover {
            background: #059669;
        }

        /* Popup styling */
        .leaflet-popup-content {
            font-size: 14px;
            font-weight: 500;
            color: #111827;
        }
    </style>
</head>

<body>
    <div id="controls">
        <input id="search" type="text" placeholder="üîç Enter barangay (e.g. Sillawit, Cauayan City)">
        <button onclick="searchBarangay()">Search</button>
        <button id="download" onclick="downloadGeoJSON()">‚¨á Download GeoJSON</button>
    </div>
    <div id="map"></div>

    <script>
        var map = L.map('map').setView([16.9293, 121.7740], 13); // Default Isabela
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
        }).addTo(map);

        var currentLayer = null;
        var purokLayer = null;
        var currentGeoJSON = null;

        async function searchBarangay() {
            let name = document.getElementById("search").value.trim();
            if (!name) return;

            let query = `
                [out:json][timeout:25];
                relation["boundary"="administrative"]["admin_level"="10"]["name"="${name}"];
                out geom;
            `;
            let url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);

            let response = await fetch(url);
            let data = await response.json();

            if (!data.elements.length) {
                alert("‚ùå No barangay boundary found for: " + name);
                document.getElementById("download").style.display = "none";
                return;
            }

            currentGeoJSON = osmtogeojson(data);

            if (currentLayer) map.removeLayer(currentLayer);
            if (purokLayer) map.removeLayer(purokLayer);

            currentLayer = L.geoJSON(currentGeoJSON, {
                style: {
                    color: "#ef4444",
                    weight: 2,
                    fillColor: "#f87171",
                    fillOpacity: 0.25
                }
            }).addTo(map);

            map.fitBounds(currentLayer.getBounds());
            document.getElementById("download").style.display = "inline-block";

            await searchPuroks(name);
        }

        async function searchPuroks(barangayName) {
            let query = `
                [out:json][timeout:25];
                relation["boundary"="administrative"]["name"="${barangayName}"]->.a;
                (
                  node["place"="neighbourhood"](area.a);
                  way["place"="neighbourhood"](area.a);
                  relation["place"="neighbourhood"](area.a);
                  node["place"="hamlet"](area.a);
                  way["place"="hamlet"](area.a);
                  relation["place"="hamlet"](area.a);
                );
                out geom;
            `;
            let url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);

            let response = await fetch(url);
            let data = await response.json();

            if (!data.elements.length) {
                console.log("‚ÑπÔ∏è No puroks found for " + barangayName);
                return;
            }

            let purokGeoJSON = osmtogeojson(data);

            purokLayer = L.geoJSON(purokGeoJSON, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: "#3b82f6",
                        color: "#1e40af",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).bindPopup("üìç Purok: " + (feature.properties.tags.name || "Unnamed"));
                },
                style: {
                    color: "#3b82f6",
                    weight: 1,
                    fillColor: "#93c5fd",
                    fillOpacity: 0.4
                }
            }).addTo(map);
        }

        function downloadGeoJSON() {
            if (!currentGeoJSON) return;
            let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentGeoJSON));
            let link = document.createElement("a");
            link.setAttribute("href", dataStr);
            link.setAttribute("download", document.getElementById("search").value + ".geojson");
            link.click();
        }
    </script>
</body>
</html>
